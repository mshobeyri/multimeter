<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="https://microsoft.github.io/vscode-codicons/dist/codicon.css">
</head>

<body>
    <div id="history-list"></div>
    <style>
        .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .history-row {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.15s;
            font-family: var(--vscode-font-family, monospace);
            font-size: 12px;
            margin-bottom: 2px;
            position: relative;
        }

        .history-row:hover {
            background: var(--vscode-list-hoverBackground, #2a2d2e);
        }

        .history-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            opacity: 0.9;
            vertical-align: middle;
        }

        .history-title {
            flex: 1;
            color: var(--vscode-list-foreground, #d4d4d4);
            font-size: 12px;
            margin-left: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-time {
            font-size: 11px;
            color: #aaa;
            margin-left: 12px;
            min-width: 90px;
            text-align: right;
        }

        .drawer-content {
            background: var(--vscode-editor-background, #23272e);
            border-radius: 0 0 8px 8px;
            margin: 0 0 8px 0;
            padding: 18px 24px;
            /* more padding inside drawer */
            font-size: 13px;
            color: var(--vscode-editor-foreground, #d4d4d4);
            border-top: 1px solid #444;
            white-space: pre-wrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            animation: drawerOpen 0.2s;
        }

        .drawer-section {
            margin-bottom: 18px;
            /* more space between sections */
        }

        .drawer-label {
            font-weight: bold;
            color: #66bb6a;
            margin-right: 8px;
        }

        .drawer-value {
            color: #d4d4d4;
            font-family: var(--vscode-font-family, monospace);
            word-break: break-all;
        }

        .drawer-table {
            border-collapse: collapse;
            margin-top: 8px;
            /* more space above table */
            margin-bottom: 12px;
            /* more space below table */
            min-width: 240px;
            max-width: 600px;
        }

        .drawer-table th,
        .drawer-table td {
            border: 1px solid #444;
            padding: 6px 16px;
            /* more padding in table cells */
            font-size: 12px;
            text-align: left;
            vertical-align: top;
        }

        .drawer-table th {
            background: none;
            color: #66bb6a;
            font-weight: bold;
            width: 90px;
            padding-right: 16px;
        }

        .drawer-table td {
            background: none;
            color: #d4d4d4;
        }

        .drawer-content pre {
            background: #222;
            color: #d4d4d4;
            padding: 10px 16px;
            /* more padding in content view */
            border-radius: 4px;
            font-size: 12px;
            margin: 0;
            overflow-x: auto;
        }

        @keyframes drawerOpen {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .drawer-arrow {
            margin-right: 6px;
            font-size: 13px;
            color: #888;
            transition: transform 0.2s;
            cursor: pointer;
            user-select: none;
        }

        .drawer-arrow.open {
            transform: rotate(90deg);
            color: #3399ff;
        }
    </style>
    <script>
        const vscode = acquireVsCodeApi();
        const history = __HISTORY_DATA__;
        let openIdx = null;

        function getTypeIcon(type) {
            return type === 'send'
                ? '<span class="codicon codicon-arrow-up" style="color:#3399ff"></span>'
                : type === 'recv'
                    ? '<span class="codicon codicon-arrow-down" style="color:#66bb6a"></span>'
                    : '<span class="codicon codicon-chrome-close" style="color:#ff5555"></span>';
        }
        function getProtocolIcon(protocol) {
            if (protocol === 'ws') return '<img src="__WS_ICON__" class="history-icon" />';
            if (protocol === 'grpc') return '<img src="__GRPC_ICON__" class="history-icon" />';
            return '<img src="__HTTP_ICON__" class="history-icon" />';
        }

        function renderVerticalTable(obj) {
            if (!obj || Object.keys(obj).length === 0) return '';
            return '<table class="drawer-table">' +
                Object.entries(obj).map(function ([key, val]) {
                    return '<tr><th>' + key + '</th><td>' + val + '</td></tr>';
                }).join('') +
                '</table>';
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML =
                '<ul class="history-list">' +
                history.map(function (item, idx) {
                    const isError = item.type === 'error';
                    return '<li>' +
                        '<div class="history-row" onclick="toggleDrawer(' + idx + ')">' +
                        '<span class="drawer-arrow' + (openIdx === idx ? ' open' : '') + '">&#9654;</span>' +
                        getTypeIcon(item.type) +
                        getProtocolIcon(item.protocol) +
                        '<span class="history-title"' + (isError ? ' style="color:#ff5555;"' : '') + '>' + item.title + '</span>' +
                        '<span class="history-time">' +
                        (item.duration
                            ? '<span style="color:' + (isError ? '#ff5555' : '#66bb6a') + ';">(' + item.duration + 'ms)</span> '
                            : '') +
                        (item.status !== undefined
                            ? (
                                isError
                                ? '<span style="color:#ff5555;font-weight: bold;">[' + item.status + ']</span> '
                                : '<span style="color:#66bb6a;font-weight: bold;">[' + item.status + ']</span> '
                              )
                            : ''
                        ) +
                        item.time +
                        '</span>' +
                        '</div>' +
                        (openIdx === idx
                            ? '<div class="drawer-content">' +
                            '<div class="drawer-section"><span class="drawer-label">Method:</span> <span class="drawer-value">' + item.method + '</span></div>' +
                            '<div class="drawer-section"><span class="drawer-label">Protocol:</span> <span class="drawer-value">' + item.protocol + '</span></div>' +
                            (item.status !== undefined
                                ? (
                                    isError
                                    ? '<div class="drawer-section"><span class="drawer-label">Status:</span> <span class="drawer-value" style="color:#ff5555;">' + item.status + '</span></div>'
                                    : '<div class="drawer-section"><span class="drawer-label">Status:</span> <span class="drawer-value" style="color:#66bb6a;">' + item.status + '</span></div>'
                                  )
                                : ''
                            ) +
                            (item.cookies && Object.keys(item.cookies).length
                                ? '<div class="drawer-section"><span class="drawer-label">Cookies:</span>' + renderVerticalTable(item.cookies) + '</div>' : '') +
                            (item.headers && Object.keys(item.headers).length
                                ? '<div class="drawer-section"><span class="drawer-label">Headers:</span>' + renderVerticalTable(item.headers) + '</div>' : '') +
                            (item.query && Object.keys(item.query).length
                                ? '<div class="drawer-section"><span class="drawer-label">Query:</span>' + renderVerticalTable(item.query) + '</div>' : '') +
                            (item.content
                                ? '<div class="drawer-section"><span class="drawer-label">Content:</span><pre>' + item.content.replace(/</g, "&lt;").replace(/>/g, "&gt;") + '</pre></div>' : '') +
                            '</div>'
                            : '') +
                        '</li>';
                }).join('') +
                '</ul>';
        }

        window.toggleDrawer = function (idx) {
            openIdx = openIdx === idx ? null : idx;
            renderHistory();
        };

        window.addEventListener('message', function (event) {
            const msg = event.data;
            if (msg.command === 'refreshHistory') {
                vscode.postMessage({ type: 'refreshHistory' });
            }
        });

        window.addEventListener('message', function (event) {
            const msg = event.data;
            if (msg.command === 'setHistory') {
                window.history = msg.history;
                renderHistory();
            }
        });

        renderHistory();
    </script>
</body>

</html>